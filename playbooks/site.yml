# playbooks/site.yml
---

# ğŸ› ï¸ Pre-Flight Checks
- name: "ğŸ› ï¸ Pre-Flight Checks"
  hosts: reservations
  become: true
  gather_facts: true
  vars_files:
    - ../group_vars/main.yml
    - "../group_vars/{{ (ansible_distribution | lower).replace(' ', '_') }}.yml"
  vars:
    container_runtime: docker
    has_nvidia: false
  tasks:
    - name: "ğŸ” Include Kubernetes Pre-Flight Checks"
      include_role:
        name: kubernetes
        tasks_from: preflight.yml
      tags: [always, preflight]

    - name: "ğŸ“¦ Include Container Pre-Flight Checks"
      include_role:
        name: container
        tasks_from: main.yml
      tags: [always, preflight]

# ğŸ³ Configure Container Runtime
- name: "ğŸ³ Configure Container Runtime"
  hosts: reservations
  become: true
  roles:
    - role: container
      tags: [container, docker]

# ğŸ® Configure GPU Nodes (if applicable)
- name: "ğŸ® Configure GPU Nodes"
  hosts: gpu_nodes
  become: true
  roles:
    - role: nvidia
      tags: [gpu, nvidia]

# ğŸ‘‘ Initialize Control Plane
- name: "ğŸ‘‘ Initialize Control Plane"
  hosts: master
  become: true
  tasks:
    - name: "Include Kubernetes Master Setup"
      import_role:
        name: kubernetes
        tasks_from: master.yml
      tags: [kubernetes, master]

# ğŸ§‘â€ğŸš€ Join Worker Nodes
- name: "ğŸ§‘â€ğŸš€ Join Worker Nodes"
  hosts: workers
  become: true
  tasks:
    - name: "Include Kubernetes Worker Setup"
      import_role:
        name: kubernetes
        tasks_from: worker.yml
      tags: [kubernetes, worker]

# âœ… Validate Deployment
- name: "âœ… Validate Deployment"
  hosts: reservations
  become: true
  tasks:
    - name: "Include Kubernetes Validation Tasks"
      import_role:
        name: kubernetes
        tasks_from: verify.yml
      tags: [kubernetes, verify]