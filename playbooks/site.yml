# playbooks/site.yml
# Define the master playbook that orchestrates the deployment of the Kubernetes cluster.

# playbooks/site.yml
---
- name: Validate cluster prerequisites
  hosts: reservations
  gather_facts: true
  vars_files:
    - ../group_vars/main.yml
    - "../group_vars/{{ 'ubuntu.yml' if ansible_distribution == 'Ubuntu' else 'rocky.yml' }}"
  tasks:
    - name: Include system checks
      include_tasks: "{{ lookup('first_found', possible_files) }}"
      vars:
        possible_files:
          - ../roles/common/tasks/main.yml
      tags: always,prerequisites

- name: Configure base system
  hosts: reservations
  vars_files:
    - ../group_vars/main.yml
    - ../group_vars/{{ ansible_distribution | lower }}.yml
  roles:
    - role: common
      tags: common

- name: Setup container runtime
  hosts: reservations
  roles:
    - role: docker
      tags: docker

- name: Configure GPU nodes
  hosts: gpu
  roles:
    - role: nvidia
      tags: nvidia

- name: Deploy Kubernetes cluster
  hosts: reservations
  vars_files:
    - ../group_vars/k8s-cluster.yml
  roles:
    - role: kubernetes
      tags: kubernetes

- name: Initialize control plane
  hosts: master
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/master.yml
      tags: master

- name: Join worker nodes
  hosts: workers
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/worker.yml
      tags: workers

- name: Validate deployment
  hosts: reservations
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/verify.yml
      tags: verify

- name: Verify GPU resources
  hosts: gpu
  tasks:
    - name: Check GPU allocation
      command: kubectl describe node {{ inventory_hostname }} | grep nvidia.com/gpu
      register: gpu_check
      failed_when: "'nvidia.com/gpu' not in gpu_check.stdout"
      changed_when: false