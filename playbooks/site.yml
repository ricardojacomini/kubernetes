# playbooks/site.yml
# Define the master playbook that orchestrates the deployment of the Kubernetes cluster.

# playbooks/site.yml
---
- name: Validate cluster prerequisites
  hosts: all
  gather_facts: true
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/os/{{ ansible_distribution | lower }}.yml
  tasks:
    - name: Run preflight checks
      include_tasks: ../roles/common/tasks/preflight.yml
      tags: always,prerequisites

- name: Configure base system
  hosts: all
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/os/{{ ansible_distribution | lower }}.yml
  roles:
    - role: common
      tags: common

- name: Setup container runtime
  hosts: all
  roles:
    - role: docker
      tags: docker

- name: Configure GPU nodes
  hosts: gpu
  roles:
    - role: nvidia
      tags: nvidia

- name: Deploy Kubernetes cluster
  hosts: all
  vars_files:
    - ../group_vars/k8s-cluster.yml
  roles:
    - role: kubernetes
      tags: kubernetes

- name: Initialize control plane
  hosts: master
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/master.yml
      tags: master

- name: Join worker nodes
  hosts: workers
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/worker.yml
      tags: workers

- name: Validate deployment
  hosts: all
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/verify.yml
      tags: verify