# playbooks/site.yml
# Define the master playbook that orchestrates the deployment of the Kubernetes cluster.
# ---

---
# playbooks/site.yml

- name: Preflight checks and system preparation
  hosts: reservations
  gather_facts: true
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/os/{{ ansible_distribution | lower }}.yml
  tasks:
    - name: Validate system requirements
      include_tasks: ../roles/common/tasks/preflight.yml
      tags: prerequisites

- name: Configure infrastructure foundation
  hosts: reservations
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/os/{{ ansible_distribution | lower }}.yml
  roles:
    - role: common
      tags: [common, system]
    - role: docker
      tags: [docker, container_runtime]
    - role: nvidia
      when: "'gpu' in group_names"
      tags: [gpu, nvidia]

- name: Deploy Kubernetes cluster
  hosts: reservations
  vars_files:
    - ../group_vars/k8s-cluster.yml
  roles:
    - role: kubernetes
      tags: [kubernetes, cluster]
  tasks:
    - name: Initialize control plane
      include_tasks: ../roles/kubernetes/tasks/master.yml
      when: "'master' in group_names"
      tags: [master, control_plane]

    - name: Join worker nodes
      include_tasks: ../roles/kubernetes/tasks/worker.yml
      when: "'workers' in group_names"
      tags: [workers, nodes]

- name: Post-deployment validation
  hosts: reservations
  tasks:
    - name: Verify cluster health
      include_tasks: ../roles/kubernetes/tasks/verify.yml
      tags: [validation, verify]