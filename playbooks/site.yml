# playbooks/site.yml
---
- name: "🛠️ Pre-Flight Configuration"
  hosts: reservations
  become: true  # 👈 Global privilege escalation for all roles and tasks
  gather_facts: true
  vars_files:
    - ../group_vars/main.yml
    - "../group_vars/{{ (ansible_distribution | lower).replace(' ', '_') }}.yml"
  tasks:
    - name: "🔍 Include Kubernetes Pre-Flight Checks"
      include_role:
        name: kubernetes
        tasks_from: preflight.yml
      tags: [always, preflight]

    - name: "📦 Include Container Pre-Flight Checks"
      include_role:
        name: container
        tasks_from: main.yml  # Changed from non-existent preflight.yml
      tags: [always, preflight]

- name: "🐳 Configure Container Runtime"
  hosts: reservations
  roles:
    - role: container
      tags: [container, docker]
  vars:
    container_runtime: "docker"

- name: "🎮 Configure GPU Nodes"
  hosts: gpu
  roles:
    - role: container
      tags: [container, nvidia]
  vars:
    has_nvidia: true

- name: "☸️ Deploy Kubernetes Cluster"
  hosts: reservations
  roles:
    - role: kubernetes
      tags: kubernetes
  vars_files:
    - ../group_vars/k8s-cluster.yml

- name: "👑 Initialize Control Plane"
  hosts: master
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/master.yml
      tags: [kubernetes, master]

- name: "🛠️ Join Worker Nodes"
  hosts: workers
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/worker.yml
      tags: [kubernetes, workers]

- name: "✅ Validate Deployment"
  hosts: reservations
  tasks:
    - include_tasks: ../roles/kubernetes/tasks/verify.yml
      tags: [kubernetes, verify]

- name: "📊 Verify GPU Resources"
  hosts: gpu
  tasks:
    - name: Check GPU allocation
      command: kubectl describe node {{ inventory_hostname }} | grep nvidia.com/gpu
      register: gpu_check
      failed_when: "'nvidia.com/gpu' not in gpu_check.stdout"
      changed_when: false
      tags: [nvidia, verify]