# roles/kubernetes/tasks/worker.yml
---
- name: Install Kubernetes packages
  package:
    name:
      - kubelet-{{ k8s_version }}
      - kubeadm-{{ k8s_version }}
    state: present

- name: Configure kubelet
  template:
    src: kubelet.conf.j2
    dest: /etc/sysconfig/kubelet
    owner: root
    group: root
    mode: 0644
  notify: restart kubelet

- name: Add NVIDIA repository (Ubuntu)
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/ubuntu{{ ansible_distribution_version }}/$(ARCH) /"
    filename: nvidia-container-toolkit
  when: ansible_distribution == 'Ubuntu'

- name: Install NVIDIA toolkit (Ubuntu)
  apt:
    name: nvidia-container-toolkit
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Add NVIDIA repository (Rocky)
  yum_repository:
    name: nvidia-container-toolkit
    description: NVIDIA Container Toolkit
    baseurl: https://nvidia.github.io/libnvidia-container/stable/rhel$releasever/$basearch
    gpgkey: https://nvidia.github.io/libnvidia-container/gpgkey
    gpgcheck: true
    enabled: true
  when: ansible_distribution == 'Rocky'

- name: "üîç Verify Network Range Availability (Worker)"
  shell: |
    ! ip route show | grep -q 192.168.1.0/24 &&
    ! ip route show | grep -q 192.168.2.0/24
  register: network_check
  failed_when: network_check.rc != 0
  changed_when: false
  tags: validation

- name: "üîó Join Kubernetes Cluster"
  command: "{{ lookup('file', '/tmp/join-command.sh') }}"
  args:
    creates: /etc/kubernetes/kubelet.conf
  environment:
    KUBELET_EXTRA_ARGS: "--node-ip={{ ansible_default_ipv4.address }}"
  when: inventory_hostname in groups['workers']

- name: Configure containerd for Kubernetes
  template:
    src: containerd.conf.j2
    dest: /etc/containerd/config.toml
  notify: restart containerd

- name: "‚è±Ô∏è Wait for Node Registration"
  wait_for:
    path: /etc/kubernetes/kubelet.conf
    timeout: 120