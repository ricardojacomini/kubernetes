# roles/kubernetes/tasks/preflight.yml
---
- name: "ğŸ›¡ï¸ Base System Configuration"
  block:
    - name: "ğŸ“¦ Install common packages"
      ansible.builtin.package:  # Explicit module name
        name: "{{ item }}"
        state: present
      loop:
        - conntrack
        - socat
        - ebtables
        - ethtool
        - ipset
        - nfs-common
      tags: always

    - name: "ğŸ”§ Load required kernel modules"
      ansible.builtin.modprobe:  # FQCN for modprobe
        name: "{{ item }}"
        state: present
        persistent: yes
      loop:
        - overlay
        - br_netfilter
        - nf_conntrack
      tags: always

    - name: "ğŸ“ Configure kernel sysctl parameters"
      ansible.builtin.sysctl:  # Explicit module name
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
        sysctl_set: yes
      loop:
        - { key: "net.bridge.bridge-nf-call-iptables", value: "1" }
        - { key: "net.ipv4.ip_forward", value: "1" }
        - { key: "vm.swappiness", value: "0" }
      tags: always

- name: "âš™ï¸ Hardware Validation"
  block:
    - name: "ğŸ”„ Verify swap is disabled"
      shell: swapon --show | wc -l
      register: swap_status
      changed_when: false
      failed_when: swap_status.stdout != "0"
      tags: validation

    - name: "ğŸ® NVIDIA GPU Pre-checks"
      block:
        - name: Detect NVIDIA GPUs
          shell: lspci | grep -iq nvidia
          register: gpu_detected
          changed_when: false
          failed_when: false
          tags: gpu,validation

        - name: Install GPU build dependencies
          package:
            name: "{{ ['gcc', 'make', 'dkms'] + 
                      (['kernel-devel'] if ansible_distribution == 'Rocky' 
                       else ['linux-headers-generic']) }}"
            state: present
          when: 
            - gpu_detected.rc == 0
            - "'gpu' in group_names"
          tags: gpu
      when: "'gpu' in group_names"  # Only run on GPU nodes