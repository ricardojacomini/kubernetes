# roles/container/handlers
---
- name: ğŸ³ Install Container
  block:
    #  Restart Docker
    - name: restart docker
      ansible.builtin.service:
        name: docker
        state: restarted
      when: container_runtime == 'docker'

    # ğŸ§Š Restart Containerd
    - name: restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
      when: container_runtime == 'containerd'

    # âš¡ Apply NVIDIA Runtime Configuration (Docker only)
    - name: apply nvidia runtime
      ansible.builtin.shell: |
        systemctl restart docker
        nvidia-ctk runtime configure --runtime=docker
        systemctl restart docker
      when:
        - container_runtime == 'docker'
      tags: nvidia

    # ğŸ§° Reload Containerd Config (from toml)
    - name: reload containerd
      ansible.builtin.systemd:
        name: containerd
        state: reloaded
      when: container_runtime == 'containerd'

    # ğŸ§¹ Cleanup Temporary Files
    - name: cleanup temp files
      ansible.builtin.file:
        path: "/tmp/{{ item }}"
        state: absent
      loop:
        - nvidia_install.log
        - docker_setup.tmp
        - nvidia-container-runtime.log
        - nvidia-container-runtime-hook.log  
  tags: [container, install]
