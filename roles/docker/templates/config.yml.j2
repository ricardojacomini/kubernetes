# roles/docker/templates/config.yml.j2
{
  "debug": {{ docker_debug | default(false) | lower }},
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "{{ docker_log_driver | default('json-file') }}",
  "log-opts": {
    "max-size": "{{ docker_log_max_size | default('100m') }}",
    "max-file": "{{ docker_log_max_file | default('3') }}",
    {% if docker_log_driver == 'syslog' %}
    "syslog-address": "{{ docker_syslog_address | default('udp://localhost:514') }}",
    {% endif %}
  },
  "storage-driver": "{{ docker_storage_driver | default('overlay2') }}",
  {% if docker_storage_opts is defined and docker_storage_opts %}
  "storage-opts": {{ docker_storage_opts | to_json }},
  {% endif %}
  "data-root": "{{ docker_data_root | default('/var/lib/docker') }}",
  {% if docker_bip is defined and docker_bip %}
  "bip": "{{ docker_bip }}",
  {% endif %}
  {% if docker_mtu is defined and docker_mtu %}
  "mtu": {{ docker_mtu }},
  {% endif %}
  "default-runtime": "{{ docker_default_runtime | default('runc') }}",
  "runtimes": {
    "runc": {
      "path": "/usr/bin/runc"
    }{% if docker_runtimes is defined and docker_runtimes %},{% endif %}
    {% if docker_runtimes is defined %}
    {% for runtime_name, runtime_config in docker_runtimes.items() %}
    "{{ runtime_name }}": {
      "path": "{{ runtime_config.path }}",
      {% if runtime_config.options is defined and runtime_config.options %}
      "runtimeArgs": {{ runtime_config.options | to_json }}
      {% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
    {% endif %}
  },
  {% if docker_registry_mirrors is defined and docker_registry_mirrors %}
  "registry-mirrors": {{ docker_registry_mirrors | to_json }},
  {% endif %}
  {% if docker_insecure_registries is defined and docker_insecure_registries %}
  "insecure-registries": {{ docker_insecure_registries | to_json }},
  {% endif %}
  "live-restore": {{ docker_live_restore | default(true) | lower }},
  "icc": {{ docker_icc | default(false) | lower }},
  "userland-proxy": {{ docker_userland_proxy | default(false) | lower }},
  {% if docker_dns is defined and docker_dns %}
  "dns": {{ docker_dns | to_json }},
  {% endif %}
  {% if docker_no_proxy is defined and docker_no_proxy %}
  "no-proxy": "{{ docker_no_proxy | join(',') if docker_no_proxy is iterable else docker_no_proxy }}",
  {% endif %}
  "features": {
    "buildkit": {{ docker_buildkit_enabled | default(true) | lower }}
  }{% if docker_experimental is defined %},
  "experimental": {{ docker_experimental | lower }}
  {% endif %}
}